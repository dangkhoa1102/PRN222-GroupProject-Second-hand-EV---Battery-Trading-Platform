@page
@model GroupProject.Pages.Admin.DashboardModel
@{
    ViewData["Title"] = "Thống kê & Báo cáo";
}

<style>
    .dashboard-header {
        background: linear-gradient(135deg, #0d6efd, #6610f2);
        padding: 24px 28px;
        border-radius: 18px;
        color: #fff;
        margin-bottom: 32px;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 24px;
        box-shadow: 0 18px 40px rgba(13, 110, 253, 0.25);
    }

    .dashboard-header h1 {
        font-weight: 600;
    }

    .dashboard-header .range-select {
        background: rgba(255, 255, 255, 0.15);
        padding: 12px 18px;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .stat-card {
        padding: 20px;
        border-radius: 20px;
        background: #fff;
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.08);
        border: 1px solid rgba(226, 232, 240, 0.7);
        position: relative;
        overflow: hidden;
    }

    .stat-card__value {
        font-size: 2rem;
        font-weight: 700;
        color: #0f172a;
    }

    .stat-card__label {
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.75rem;
        font-weight: 600;
        color: #94a3b8;
        margin-bottom: 6px;
    }

    .stat-card::after {
        content: "";
        position: absolute;
        inset: 0;
        opacity: 0.15;
        background: radial-gradient(circle at top right, var(--stat-color), transparent 55%);
    }

    .stat-card--primary { --stat-color: #0d6efd; }
    .stat-card--success { --stat-color: #20c997; }
    .stat-card--warning { --stat-color: #ffc107; }
    .stat-card--danger { --stat-color: #dc3545; }

    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }

    .chart-card {
        background: #fff;
        border-radius: 24px;
        padding: 24px;
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
        border: 1px solid rgba(226, 232, 240, 0.6);
    }

    .chart-card h2 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #0f172a;
        margin-bottom: 16px;
    }
</style>

<div class="dashboard-header">
    <div>
        <p class="mb-1 text-uppercase fw-semibold small">Xin chào, Admin</p>
        <h1 class="display-6 mb-2">Bảng điều khiển doanh số</h1>
        <p class="mb-0 opacity-75">Cập nhật tức thời số lượng giao dịch, doanh thu và nhịp thị trường.</p>
    </div>
    <form method="get" class="range-select">
        <label class="fw-semibold text-white-50" for="Months">Khoảng thời gian</label>
        <select class="form-select form-select-sm border-0 shadow-none fw-semibold" id="Months" name="Months" onchange="this.form.submit()">
            @{
                var options = new[] { 3, 6, 12 };
                foreach (var option in options)
                {
                    var selected = Model.Months == option ? "selected" : null;
            <option value="@option" selected="@selected">@option tháng</option>
                }
            }
        </select>
    </form>
</div>

<div class="stat-grid">
    <div class="stat-card stat-card--primary">
        <div class="stat-card__label">Tổng giao dịch</div>
        <div class="stat-card__value">@Model.Stats.TotalOrders</div>
        <p class="mb-0 text-muted small">Tính toàn bộ hệ thống</p>
    </div>
    <div class="stat-card stat-card--success">
        <div class="stat-card__label">Đã hoàn tất</div>
        <div class="stat-card__value">@Model.Stats.CompletedOrders</div>
        <p class="mb-0 text-muted small">Đơn đã chốt và thanh toán</p>
    </div>
    <div class="stat-card stat-card--warning">
        <div class="stat-card__label">Đang chờ</div>
        <div class="stat-card__value">@Model.Stats.PendingOrders</div>
        <p class="mb-0 text-muted small">Đơn cần xử lý tiếp</p>
    </div>
    <div class="stat-card stat-card--danger">
        <div class="stat-card__label">Đã hủy</div>
        <div class="stat-card__value">@Model.Stats.CancelledOrders</div>
        <p class="mb-0 text-muted small">Đơn bị từ chối hoặc auto-cancel</p>
    </div>
</div>

<div class="chart-grid">
    <div class="chart-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <h2>Biểu đồ cột - Giao dịch theo tháng</h2>
                <span class="text-muted small">Cập nhật  @DateTime.Now.ToString("dd/MM/yyyy")</span>
            </div>
            <div class="text-end">
                <p class="text-muted small mb-1">Doanh thu cộng dồn</p>
                <strong class="fs-4 text-success">@Model.Stats.TotalRevenue.ToString("N0") đ</strong>
            </div>
        </div>
        <canvas id="ordersColumnChart" height="160"></canvas>
    </div>
    <div class="chart-card">
        <h2>Biểu đồ tròn - Tỷ trọng trạng thái</h2>
        <canvas id="statusPieChart" height="160"></canvas>
    </div>
</div>

<div class="chart-card">
    <h2>Bảng chi tiết xu hướng</h2>
    <div class="table-responsive">
        <table class="table align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Tháng</th>
                    <th>Số giao dịch</th>
                    <th>Doanh thu</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var point in Model.Stats.MonthlyTrends.OrderByDescending(t => new DateTime(t.Year, t.Month, 1)))
                {
                    <tr>
                        <td>@point.Label</td>
                        <td>@point.OrderCount</td>
                        <td>@point.Revenue.ToString("N0") đ</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" integrity="sha384-w9rC4cIwEukgqS0bkkCm1cW0XkyR3O6jwxKF1uHmIiMaivGi99ZTSdKCbFf8gKZZ" crossorigin="anonymous"></script>
    <script>
        const trendLabels = @Html.Raw(Model.TrendLabelsJson);
        const trendOrders = @Html.Raw(Model.TrendOrdersJson);
        const trendRevenue = @Html.Raw(Model.TrendRevenueJson);
        const statusLabels = @Html.Raw(Model.StatusBreakdownLabelsJson);
        const statusCounts = @Html.Raw(Model.StatusBreakdownCountsJson);

        const colorPalette = ['#0d6efd', '#ffc107', '#dc3545', '#20c997', '#6f42c1', '#fd7e14'];

        const columnCtx = document.getElementById('ordersColumnChart');
        if (columnCtx) {
            new Chart(columnCtx, {
                type: 'bar',
                data: {
                    labels: trendLabels,
                    datasets: [
                        {
                            label: 'Số giao dịch',
                            data: trendOrders,
                            backgroundColor: '#0d6efd',
                            borderRadius: 8,
                            maxBarThickness: 40
                        },
                        {
                            label: 'Doanh thu (đ)',
                            data: trendRevenue,
                            type: 'line',
                            borderColor: '#20c997',
                            backgroundColor: 'rgba(32, 201, 151, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4,
                            pointRadius: 3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    stacked: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Số giao dịch' } },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'Doanh thu (đ)' }
                        }
                    }
                }
            });
        }

        const pieCtx = document.getElementById('statusPieChart');
        if (pieCtx && statusLabels.length) {
            new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        data: statusCounts,
                        backgroundColor: statusLabels.map((_, index) => colorPalette[index % colorPalette.length]),
                        borderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }
    </script>
}

