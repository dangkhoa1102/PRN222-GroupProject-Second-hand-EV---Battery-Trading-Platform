@page
@model GroupProject.Pages.Seller.Orders.IndexModel
@{
    ViewData["Title"] = "Quản lý đơn hàng";
}

<div class="container mt-4">
    <h2 class="mb-4">Quản lý đơn hàng của tôi</h2>

    @if (!string.IsNullOrEmpty(Model.StatusMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @Model.StatusMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Tab navigation -->
    <ul class="nav nav-tabs mb-4" id="orderTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                Chờ xác nhận <span class="badge bg-warning text-dark ms-1">@Model.PendingOrders.Count</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="confirmed-tab" data-bs-toggle="tab" data-bs-target="#confirmed" type="button" role="tab">
                Đã xác nhận <span class="badge bg-info ms-1">@Model.ConfirmedOrders.Count</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button" role="tab">
                Đã hoàn thành <span class="badge bg-success ms-1">@Model.CompletedOrders.Count</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="cancelled-tab" data-bs-toggle="tab" data-bs-target="#cancelled" type="button" role="tab">
                Đã hủy <span class="badge bg-danger ms-1">@Model.CancelledOrders.Count</span>
            </button>
        </li>
    </ul>

    <!-- Tab content -->
    <div class="tab-content" id="orderTabContent">
        <!-- Đơn hàng chờ xử lý -->
        <div class="tab-pane fade show active" id="pending" role="tabpanel">
            @if (Model.PendingOrders.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Loại</th>
                                <th>Người mua</th>
                                <th>Số tiền</th>
                                <th>Thanh toán</th>
                                <th>Ngày đặt</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in Model.PendingOrders)
                            {
                                <tr>
                                    <td><strong>#@order.OrderId</strong></td>
                                    <td>
                                        @if (order.OrderType == "Vehicle")
                                        {
                                            <span class="badge bg-primary text-white">Xe điện</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-info text-white">Pin</span>
                                        }
                                    </td>
                                    <td>
                                        <div>@order.BuyerName</div>
                                        <small class="text-muted">@order.BuyerEmail</small>
                                    </td>
                                    <td><strong>@order.TotalAmount.ToString("N0") đ</strong></td>
                                    <td>@order.PaymentMethod</td>
                                    <td>@order.CreatedDate?.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>
                                        <span class="badge bg-@(order.OrderStatus switch
                                        {
                                            "Pending" => "warning text-dark",
                                            "Confirmed" => "info",
                                            "Delivered" => "primary",
                                            "Completed" => "success",
                                            "Cancelled" => "danger",
                                            _ => "secondary"
                                        })">@order.Status</span>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a asp-page="/Seller/Orders/Detail" asp-route-id="@order.OrderId" class="btn btn-sm btn-outline-primary" title="Xem chi tiết">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            @if (order.OrderStatus == "Pending")
                                            {
                                                <form method="post" asp-page-handler="Confirm" asp-route-id="@order.OrderId" class="d-inline" onsubmit="return confirm('Xác nhận đơn hàng #@order.OrderId?')">
                                                    <button type="submit" class="btn btn-sm btn-success" title="Xác nhận">
                                                        <i class="bi bi-check-circle"></i>
                                                    </button>
                                                </form>
                                                <button type="button" class="btn btn-sm btn-danger" title="Từ chối"
                                                        data-bs-toggle="modal" data-bs-target="#rejectModal@(order.OrderId)">
                                                    <i class="bi bi-x-circle"></i>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @* Modal Reject cho từng đơn hàng *@
                @foreach (var order in Model.PendingOrders)
                {
                    <div class="modal fade" id="rejectModal@(order.OrderId)" tabindex="-1" aria-labelledby="rejectModalLabel@(order.OrderId)" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form method="post" asp-page-handler="Reject" asp-route-id="@order.OrderId">
                                    <div class="modal-header bg-danger text-white">
                                        <h5 class="modal-title" id="rejectModalLabel@(order.OrderId)">
                                            <i class="bi bi-exclamation-triangle"></i> Từ chối đơn hàng #@order.OrderId
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="alert alert-warning">
                                            <strong>Cảnh báo:</strong> Đơn hàng sẽ bị hủy sau khi từ chối!
                                        </div>
                                        <p><strong>Người mua:</strong> @order.BuyerName</p>
                                        <p><strong>Sản phẩm:</strong> @order.ItemName</p>
                                        <p><strong>Số tiền:</strong> @order.TotalAmount.ToString("N0") đ</p>
                                        <hr />
                                        <div class="mb-3">
                                            <label for="reason@(order.OrderId)" class="form-label">Lý do từ chối: <span class="text-danger">*</span></label>
                                            <textarea class="form-control" id="reason@(order.OrderId)" name="reason" rows="3"
                                                      placeholder="Vui lòng nhập lý do từ chối đơn hàng..." required></textarea>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                        <button type="submit" class="btn btn-danger">
                                            <i class="bi bi-x-circle"></i> Xác nhận từ chối
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Không có đơn hàng nào đang chờ xử lý.
                </div>
            }
        </div>

        <!-- Đơn hàng đã xác nhận -->
        <div class="tab-pane fade" id="confirmed" role="tabpanel">
            @if (Model.ConfirmedOrders.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Loại</th>
                                <th>Người mua</th>
                                <th>Số tiền</th>
                                <th>Thanh toán</th>
                                <th>Ngày đặt</th>
                                <th>Ngày xác nhận</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in Model.ConfirmedOrders)
                            {
                                <tr>
                                    <td><strong>#@order.OrderId</strong></td>
                                    <td>
                                        @if (order.OrderType == "Vehicle")
                                        {
                                            <span class="badge bg-primary text-white">Xe điện</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-info text-white">Pin</span>
                                        }
                                    </td>
                                    <td>
                                        <div>@order.BuyerName</div>
                                        <small class="text-muted">@order.BuyerEmail</small>
                                    </td>
                                    <td><strong>@order.TotalAmount.ToString("N0") đ</strong></td>
                                    <td>@order.PaymentMethod</td>
                                    <td>@order.CreatedDate?.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>@order.CompletedDate?.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>
                                        <span class="badge bg-info">@order.Status</span>
                                    </td>
                                    <td>
                                        <a asp-page="/Seller/Orders/Detail" asp-route-id="@order.OrderId" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i> Xem
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Chưa có đơn hàng nào đã được xác nhận.
                </div>
            }
        </div>

        <!-- Đơn hàng đã hoàn thành -->
        <div class="tab-pane fade" id="completed" role="tabpanel">
            @if (Model.CompletedOrders.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Loại</th>
                                <th>Người mua</th>
                                <th>Số tiền</th>
                                <th>Thanh toán</th>
                                <th>Ngày đặt</th>
                                <th>Ngày nhận hàng</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in Model.CompletedOrders)
                            {
                                <tr>
                                    <td><strong>#@order.OrderId</strong></td>
                                    <td>
                                        @if (order.OrderType == "Vehicle")
                                        {
                                            <span class="badge bg-primary text-white">Xe điện</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-info text-white">Pin</span>
                                        }
                                    </td>
                                    <td>
                                        <div>@order.BuyerName</div>
                                        <small class="text-muted">@order.BuyerEmail</small>
                                    </td>
                                    <td><strong>@order.TotalAmount.ToString("N0") đ</strong></td>
                                    <td>@order.PaymentMethod</td>
                                    <td>@order.CreatedDate?.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>@order.DeliveryDate?.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>
                                        <span class="badge bg-success">@order.Status</span>
                                    </td>
                                    <td>
                                        <a asp-page="/Seller/Orders/Detail" asp-route-id="@order.OrderId" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i> Xem
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Chưa có đơn hàng nào được hoàn thành.
                </div>
            }
        </div>

        <!-- Đơn hàng đã hủy -->
        <div class="tab-pane fade" id="cancelled" role="tabpanel">
            @if (Model.CancelledOrders.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Loại</th>
                                <th>Người mua</th>
                                <th>Số tiền</th>
                                <th>Thanh toán</th>
                                <th>Ngày đặt</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in Model.CancelledOrders)
                            {
                                <tr>
                                    <td><strong>#@order.OrderId</strong></td>
                                    <td>
                                        @if (order.OrderType == "Vehicle")
                                        {
                                            <span class="badge bg-primary text-white">Xe điện</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-info text-white">Pin</span>
                                        }
                                    </td>
                                    <td>
                                        <div>@order.BuyerName</div>
                                        <small class="text-muted">@order.BuyerEmail</small>
                                    </td>
                                    <td><strong>@order.TotalAmount.ToString("N0") đ</strong></td>
                                    <td>@order.PaymentMethod</td>
                                    <td>@order.CreatedDate?.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>
                                        <span class="badge bg-danger">@order.Status</span>
                                    </td>
                                    <td>
                                        <a asp-page="/Seller/Orders/Detail" asp-route-id="@order.OrderId" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i> Xem
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Chưa có đơn hàng nào bị hủy.
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
}
